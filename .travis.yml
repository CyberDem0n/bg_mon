sudo: true
dist: trusty
language: c
compiler: gcc
matrix:
  include:
  - addons:
      postgresql: "9.3"
  - addons:
      postgresql: "9.4"
  - addons:
      postgresql: "9.5"
  - addons:
      postgresql: "9.6"
  - addons:
      postgresql: "10"
      apt:
        packages:
          - postgresql-10
before_install:
  - sudo apt-get update
  - version=$(postgres -V | sed -n 's/^.* \([1-9][0-9]*\(\.[0-9]*\)\{0,2\}\).*/\1/p')
  - version=${version%.*}
  - sudo apt-get install -y postgresql-server-dev-$version libevent-dev pv
  - sudo pip install --upgrade cpp-coveralls
script:
  - |
    set -e
    sudo make USE_PGXS=1 ENABLE_GCOV=1 install
    initdb test_cluster
    echo "host replication all 127.0.0.1/32 trust" >> test_cluster/pg_hba.conf
    echo "unix_socket_directories = '.'" >> test_cluster/postgresql.conf
    echo "wal_level = 'hot_standby'" >> test_cluster/postgresql.conf
    echo "max_wal_senders = 5" >> test_cluster/postgresql.conf
    if [ $version != "9.3" ] && [ $version != "9.4" ]; then echo "cluster_name = ' bgworker: test cluster'" >> test_cluster/postgresql.conf; fi
    echo "shared_preload_libraries = ' bg_mon'" >> test_cluster/postgresql.conf
    pg_ctl -w -D test_cluster start -o "--port=5440"
    psql -h localhost -p 5440 -d postgres -c "select pg_advisory_lock(1), pg_sleep(30)" &
    sleep 1
    psql -h localhost -p 5440 -d postgres -c "select pg_advisory_lock(1), pg_sleep(5)" &
    ( time pg_basebackup -D test_cluster_backup -c fast -h localhost -p 5440 -F t -D - | pv -qL 2M > /dev/null )&
    sleep 1
    echo "bg_mon.port = 8081" >> test_cluster/postgresql.conf
    pg_ctl -D test_cluster reload
    curl http://localhost:8081/ui > /dev/null
    ( for a in {1..10}; do curl http://localhost:8081 && echo && sleep 1 && ps auxwwwf | grep postgres; done )&
    wait
    pg_ctl -w -D test_cluster stop
    set +e
after_success:
  - coveralls --gcov-options '\-lr'
